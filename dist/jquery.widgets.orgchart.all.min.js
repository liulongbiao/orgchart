(function(e,t,n,r){function u(e){return/^[0-9a-z\(\)\.]$/g.test(e)}function a(e){e=n(e);var t=0,r=e.length,i;for(var s=0;s<r;s++)i=e.charAt(s),u(i)&&t++;return r-.5*t}function f(e){var t=e._v_txt_spt;if(typeof t=="undefined"){var n=e.text(-1e3,-1e3,""),i=n.node.style;t=e._v_txt_spt=i.writingMode!==r&&i.glyphOrientationVertical!==r,n.remove()}return t}var i="#000000",s="#FFFFFF",o="#0000FF";e.fn.htext=function(n){var r=t.extend({},e.fn.htext.defaults,n||{});return this.text(r.x,r.y,r.text).attr({"font-size":r.fz,fill:r.color})},e.fn.htext.defaults={x:0,y:0,text:"",fz:12,color:i},e.fn.vtext=function(n){var r=t.extend({},e.fn.htext.defaults,n||{}),i=r.text,s=r.fz,o=this,u=f(o),l=null,c,h;if(u)l=o.htext(n),h=l.node.style,h.writingMode="tb",h.glyphOrientationVertical="auto";else{l=o.set();var p=r.y-.5*a(i)*s,d=0,v=function(e,n){var i=a(e),s=p+(d+.5*i)*r.fz,u=o.htext(t.extend({},r,{y:s,text:e}));return n&&u.rotate(90,r.x,s),d+=i,u},m,g=[];for(var y=0,b=i.length;y<b;y++)m=i.charAt(y),i.charCodeAt(y)>256?(g&&g.length&&l.push(v(g.join(""),!0)),l.push(v(m,!1)),g=[]):g.push(m);g&&g.length&&l.push(v(g.join(""),!0))}return l},e.fn.unitext=function(n){var r=t.extend({},e.fn.unitext.defaults,n||{}),i=this,s=r.vertical?i.vtext:i.htext;return s.call(i,r)},e.fn.unitext.defaults={x:0,y:0,text:"",fz:12,color:i,vertical:!1},e.fn.unirect=function(n){var r=t.extend({},e.fn.unirect.defaults,n||{}),i=this.rect(r.x,r.y,r.width,r.height,r.r);return i.attr({fill:r.color,"stroke-width":.5}),i},e.fn.unirect.defaults={x:0,y:0,width:10,height:10,r:1,color:s},e.fn.twinBox=function(n){var r=t.extend({},e.fn.twinBox.defaults,n||{}),i=this,o,u,f,l,c=r.cx,h=r.cy,p=r.fz,d=r.color,v=r.lineHeight,m=r.text1,g=r.text2,y=Math.max(a(m),a(g))+1,b,w;r.vertical?(b=y*p,w=v*p,o=i.unirect({x:c-w,y:h-.5*b,width:w,height:b,color:d}),u=i.unitext({x:c-.5*v*p,y:h,text:m,fz:p,color:s,vertical:!0}),f=i.unirect({x:c,y:h-.5*b,width:w,height:b}),l=i.unitext({x:c+.5*v*p,y:h,text:g,fz:p,color:d,vertical:!0})):(w=y*p,b=v*p,f=i.unirect({x:c-.5*w,y:h-b,width:w,height:b,color:d}),u=i.unitext({x:c,y:h-.5*v*p,text:m,fz:p,color:s,vertical:!1}),f=i.unirect({x:c-.5*w,y:h,width:w,height:b}),l=i.unitext({x:c,y:h+.5*v*p,text:g,fz:p,color:d,vertical:!1}));var E=i.set();return E.push(o,u,f,l),E},e.fn.twinBox.defaults={cx:0,cy:0,text1:"node",text2:"",fz:12,lineHeight:1.5,color:o,vertical:!1},e.fn.singleBox=function(n){var r=t.extend({},e.fn.singleBox.defaults,n||{}),i=this,o,u,f=r.cx,l=r.cy,c=r.fz,h=r.color,p=r.lineHeight,d=r.text,v=a(d)+1,m,g,y=r.vertical;y?(g=p*c,m=v*c):(g=v*c,m=p*c),o=i.unirect({x:f-.5*g,y:l-.5*m,width:g,height:m,color:h}),u=i.unitext({x:f,y:l,text:d,fz:c,color:s,vertical:y});var b=i.set();return b.push(o,u),b},e.fn.singleBox.defaults={cx:0,cy:0,text:"node",fz:12,lineHeight:2,color:o,vertical:!1}})(Raphael,jQuery,String),function(e,t,n,r,i){function a(e){return/^[0-9a-z\(\)\.]$/g.test(e)}function f(e,t){t===i?t=e.length:t<0&&(t=e.length-t);var n=0;for(var r=0;r<t;r++)n+=e[r];return n}function l(){var e=n.floor(255*n.random()).toString(16);return e.length===1&&(e="0"+e),e}function c(e,t){this.info=e,this.children=t&&t.length?t:[]}function h(e,t,n,r){this.x=e,this.y=t,this.width=n,this.height=r}var s=n.max,o=n.min,u=n.floor;c.prototype={addChild:function(e){this.children.push(e)},isLeaf:function(){return this.children.length===0},isRoot:function(){return this._level===1}},h.prototype={point:function(e,t){var n=this,r=n.x,i=n.y,s=n.width,o=n.height;e=e||"center",t=t||"center";var u=e==="top"?0:e==="bottom"?1:.5,a=t==="left"?0:t==="right"?1:.5;return{x:r+s*a,y:i+o*u}},center:function(e){return this.point(e,"center")}},e.widget("widgets.orgchart",{version:"1.0.0",options:{idKey:"id",pIdKey:"pid",maxFz:14,minHgap:2,minVgap:4,width:960,height:480,isVert:function(e,t,n){return e>3},cellem:function(e){return 3},wordem:function(e){var t=this,n=t.options,r=t._countEm(e.name),i=t._countEm(e.value);return s(r,i)+1},paintNode:function(e,t,n,r,i){var s=this,o=s.options,u=n.center("center"),a=o.isVert.call(s,t,e,r),f;a&&i._color?f=i._color:f=s._randomColor(),r._color=f;var l=s._paper.twinBox({cx:u.x,cy:u.y,text1:e.name,text2:e.value,fz:s._fz,color:f,vertical:a});l.click(function(){s._trigger("nodeclick",null,e,r)})}},_create:function(){var e=this,n=e.element.get(0),r=e.options;e._paper=t(n,r.width,r.height)},_init:function(){var e=this,t=e.element,n=e.options,r=n.width,i=n.height;t.css({width:r,height:i}),e._paper.setSize(r,i),e.draw([])},draw:function(e,t){var n=this;n.clear();var r=n._buildTree(e,t);if(!r)return n._drawEmpty(),!1;n.rows=0,n.vgroup={},n.vems={},n._preRows(r,1),n.columns=0,n._preColumns(r),n._vpos={},n._calcFontSize(r),n._preBox(r),n._draw(r)},_buildTree:function(t,n){var r=this,i=r.options,s=i.idKey,o=i.pIdKey,u={},a={};if(!t||t.length===0)return null;e.each(t,function(e,t){var n=t[o],r;u[t[s]]=t,r=n||"__free__",a[r]=a[r]||[],a[r].push(t)});if(!n)if(a.__free__.length===1)n=a.__free__[0][s];else{var f={name:"根节点",value:""};n=f[s]="__free__",f[o]=null,u.__free__=f}var l=r._assemble(u,a,n);return l},_assemble:function(t,n,r){var i=this,s=i.options.idKey,o=null,u=t[r],a=n[r];return u&&(o=new c(u),a&&a.length&&e.each(a,function(e,r){var u=i._assemble(t,n,r[s]);o.addChild(u)})),o},_preRows:function(t,n){var r=this,i=t.children,o=r.vgroup,u=r.vems,a=r.options;t._level=n,r.rows=s(r.rows,n),o[n]=o[n]||[],o[n].push(t);var f=t._vem=r._calcEm(t,!0);u[n]=s(u[n]||0,f),i&&i.length&&e.each(i,function(e,t){r._preRows(t,n+1)})},_calcEm:function(e,t){var n=this,r=n.options,i=e.info,s=r.isVert.call(n,e._level,i,e),o=s!=t?r.cellem:r.wordem;return o.call(n,i)},_preColumns:function(t,n){var r=this,i=r.options,o=t.children,u=t._hem=r._calcEm(t,!1);t._hem_clds=[];var a=r.columns;t.isLeaf()?r.columns+=1:e.each(o,function(e,n){r._preColumns(n,t)});var l=r.columns;t._colSpan=l-a;var c=f(t._hem_clds),h=t._hem_box=s(u,c);t._hem_margin=(h-c)/2,n&&(n._hem_clds=n._hem_clds||[],n._hem_clds.push(h))},_calcFontSize:function(e){var t=this,n=t.options,r=n.width,i=n.height,s=t.rows,u=0,a=t.vems;for(var f=1;f<=s;f++)u+=a[f];var l=(i-n.minVgap*s)/u,c=e._hem_box,h=e._colSpan,p=(r-n.minHgap*h)/c,d=o(l,p,n.maxFz);t._fz=d;var v=t._vgap=(i-u*d)/s,m=t._vpos,g=0,y=0;for(var b=1;b<=s;b++)y=a[b]*d+v,m[b]={y:g,height:y},g+=y;t._hgap=(r-c*d)/h},_preBox:function(t,n,r){var i=this,s=i.options,o=t._level,u=t.children,a=i._vpos[o],l=i._hgap,c=i._fz,p,d;if(!n)p=0,d=s.width;else{var v=n._bbox,m=v.width,g=n.children,y=n._hem_clds,b=f(y,r),w=0;for(var E=0;E<r;E++)w+=g[E]._colSpan;p=v.x+w*l+(n._hem_margin+b)*c,d=t._colSpan*l+t._hem_box*c}var S=t._bbox=new h(p,a.y,d,a.height),x,T,N=t._hem*c,C=t._vem*c,k=s.isVert.call(i,o,t.info,t);if(k){var L=S.center("top");x=L.x-N/2,T=L.y+i._vgap/2}else{var A=S.center("center");x=A.x-N/2,T=A.y-C/2}t._cbox=new h(x,T,N,C),u&&u.length&&e.each(u,function(e,n){i._preBox(n,t,e)})},_draw:function(t,n){var r=this,i=t._bbox,s=t._cbox,o=t.children,u=o.length;console.log(t),t.isRoot()||r._drawLine(i.center("top"),s.center("top")),u>0&&(r._drawLine(s.center("bottom"),i.center("bottom")),u===1?r._drawLine(o[0]._bbox.center("top"),i.center("bottom")):r._drawLine(o[0]._bbox.center("top"),o[u-1]._bbox.center("top")));var a=r.options.paintNode;e.isFunction(a)&&a.call(r,t.info,t._level,s,t,n),o&&o.length&&e.each(o,function(e,n){r._draw(n,t)})},_drawLine:function(e,t){var n="M"+e.x+","+e.y+"L"+t.x+","+t.y+"Z";this._paper.path(n).attr({"stroke-width":.2})},clear:function(){this._paper.clear()},_drawEmpty:function(){var e=this,t=e.options;e._paper.singleBox({cx:t.width/2,cy:t.height/2,text:"等待数据填充...",fz:20})},_countEm:function(e){e=r(e);var t=0,n=e.length,i;for(var s=0;s<n;s++)i=e.charAt(s),a(i)&&t++;return n-.5*t},_randomColor:function(){return"#"+l()+l()+l()},destory:function(){var t=this;t._paper.remove(),e.widgets.orgchart.prototype.destroy.call(t)}})}(jQuery,Raphael,Math,String);